name: Build and Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache APT packages
        uses: actions/cache@v3
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential cmake pkg-config \
            qt6-base-dev qt6-multimedia-dev qt6-webengine-dev libvlc-dev gh libboost-all-dev ffmpeg libsdl2-dev

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake .. \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/install_root \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_CATCH=OFF

      - name: Build project
        run: |
          cmake --build build
      - name: "List all files"
        run: |
          echo $PWD
          ls -R

      - name: Get project version
        id: get_version
        run: |
          PROJECT_VERSION=$(grep -oP 'VERSION \K[0-9]+\.[0-9]+\.[0-9]+' CMakeLists.txt | head -n 1)
          echo "PROJECT_VERSION=$PROJECT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected project version: $PROJECT_VERSION"
      - name: Rename artifact
        run: |
          mv build/mfaomp mfaomp-linux-x86_64-v${{ steps.get_version.outputs.PROJECT_VERSION }}

      - name: Create or Update GitHub Release and Upload Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: "v${{ steps.get_version.outputs.PROJECT_VERSION }}"
          GH_TOKEN: ${{ github.token }}
          ASSET_NAME: mfaomp-linux-x86_64-v${{ steps.get_version.outputs.PROJECT_VERSION }}
        run: |
          echo "Version to delete: $TAG_NAME"
          if gh release list | awk '{print $3}' | grep -x "$TAG_NAME"; then
            echo "Release $TAG_NAME found. Replacing file with current"
            gh release upload "$TAG_NAME" "$ASSET_NAME" --clobber
          else
            echo "Release $TAG_NAME not found."
            echo "Creating release for version: $TAG_NAME"
            gh release create "$TAG_NAME" --target master --title "Release $TAG_NAME" --generate-notes "$ASSET_NAME"
          fi

  build-flatpak:
    runs-on: ubuntu-latest
    needs: build-and-release
    env:
      FLATPAK_MANIFEST: "packaging/io.github.Neurofibromin.mfaomp.yaml"
      OLD_SHA256: "dd1e9b304212b484ad898d1f7bc853017a3708c69f4970f6ad3b8b8a3e89f3a9"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y flatpak flatpak-builder
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Build and handle checksum
        id: flatpak_build
        run: |
          echo "Attempting initial Flatpak build to check checksum..."
          
          # Use 'set +e' to prevent the script from exiting on the expected checksum error.
          set +e
          # Run the builder and capture all output.
          BUILD_OUTPUT=$(flatpak-builder build-dir --repo=repo "$FLATPAK_MANIFEST" 2>&1)
          BUILD_EXIT_CODE=$?
          set -e
          
          # Check if the build failed and the error is a checksum mismatch.
          if [[ $BUILD_EXIT_CODE -ne 0 ]] && echo "$BUILD_OUTPUT" | grep -q "Wrong sha256 checksum"; then
            echo "Checksum mismatch detected. Parsing output to find the new checksum..."
            # Extract the new SHA256 from the error message.
            NEW_SHA256=$(echo "$BUILD_OUTPUT" | grep 'was ' | awk '{print $5}' | sed 's/"//g')
          
            if [ -z "$NEW_SHA256" ]; then
              echo "Error: Could not extract new checksum from build output."
              exit 1
            fi
          
            echo "Found new checksum: $NEW_SHA256"
            echo "Updating manifest file..."
          
            # Use 'sed' to replace the old checksum with the new one directly in the file.
            sed -i "s/$OLD_SHA256/$NEW_SHA256/g" "$FLATPAK_MANIFEST"
          
            echo "Checksum updated. Retrying the build..."
            # Run the full build with the corrected manifest.
            # This time it should succeed.
            flatpak-builder build-dir --force-clean --user --install-deps-from=flathub --repo=repo --ccache --install "$FLATPAK_MANIFEST"
          elif [[ $BUILD_EXIT_CODE -ne 0 ]]; then
            # The build failed for a reason other than checksum, so we print the output and fail.
            echo "Flatpak build failed for an unexpected reason:"
            echo "$BUILD_OUTPUT"
            exit 1
          else
            echo "Initial build was successful. Checksum is already correct."
            # The initial build was successful, so we run the full build command.
            flatpak-builder build-dir --force-clean --user --install-deps-from=flathub --repo=repo --ccache --install "$FLATPAK_MANIFEST"
          fi

      - name: bundle
        run: |
          cd packaging
          flatpak build-bundle repo mfaomp.flatpak io.github.Neurofibromin.mfaomp --runtime-repo=https://flathub.org/repo/flathub.flatpakrepo

      - name: upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: "v${{ needs.build-and-release.steps.get_version.outputs.PROJECT_VERSION }}"
          GH_TOKEN: ${{ github.token }}
          ASSET_NAME: mfaomp-flatpak-x86_64-v${{ needs.build-and-release.steps.get_version.outputs.PROJECT_VERSION }}.flatpak
        run: |
          cd packaging
          mv mfaomp.flatpak $ASSET_NAME
          gh release upload "$TAG_NAME" "$ASSET_NAME" --clobber